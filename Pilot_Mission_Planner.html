<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot's Mission Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray */
            color: #F3F4F6; /* Light Gray */
        }
        .planner-grid {
            grid-template-columns: 6rem repeat(7, minmax(0, 1fr));
        }
        .table-cell {
            border: 1px solid #374151; /* Gray-700 */
            padding: 8px;
            min-height: 40px;
        }
        .planner-grid > .table-cell[contenteditable="true"] {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
        }
        .planner-grid > .table-cell[contenteditable="true"]:focus {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            z-index: 10;
            position: relative;
            background-color: #1F2937; /* Gray-800 */
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex;
            align-items: center; justify-content: center; z-index: 50;
        }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .amended-item { font-style: italic; color: #FBBF24; /* Amber-400 */ }
        .amended-asterisk { color: #FBBF24; font-weight: bold; margin-left: 2px; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header, Navigation, Goals, KPIs sections remain the same -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Pilot's Mission Planner</h1>
            <p class="text-gray-400 mt-1">Plan your week, track your progress, ace that checkride.</p>
        </header>
        
        <div id="mainPlannerSection">
            <div class="flex justify-between items-center mb-4">
                <button id="prevWeekBtn" class="nav-btn bg-gray-700 hover:bg-blue-600 p-2 rounded-md text-white transition-colors">&lt; Prev Week</button>
                <div class="text-center">
                    <h2 id="weekStatus" class="text-xl md:text-2xl font-bold text-white"></h2>
                    <p id="weekDateRange" class="text-sm text-gray-400"></p>
                </div>
                <button id="nextWeekBtn" class="nav-btn bg-gray-700 hover:bg-blue-600 p-2 rounded-md text-white transition-colors">Next Week &gt;</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg lg:col-span-1">
                    <h2 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Mission Goals for this Week</h2>
                    <div id="weeklyGoals" contenteditable="true" class="prose prose-invert prose-sm min-h-[100px] p-2 bg-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg shadow-lg lg:col-span-2">
                    <h2 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Key Performance Indicators (KPIs)</h2>
                    <div id="indicatorList" class="mb-3 space-y-2"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="newIndicatorInput" placeholder="New KPI (e.g., Landings)" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                        <button id="addIndicatorBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Add</button>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-between items-center bg-gray-800 p-3 rounded-t-lg shadow-lg">
                <div>
                    <span class="font-semibold mr-4">View:</span>
                    <button data-view="daily" class="view-btn bg-gray-700 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">Daily</button>
                    <button data-view="weekly" class="view-btn bg-blue-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">Weekly</button>
                </div>
                <button id="startNewWeekBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors mt-2 sm:mt-0">Advance to Next Week</button>
            </div>

            <div id="weeklyViewContainer" class="overflow-x-auto bg-gray-900 rounded-b-lg shadow-lg">
                <div id="plannerContainer" class="planner-grid grid text-sm text-center"></div>
            </div>

            <div id="dailyViewContainer" class="hidden bg-gray-900 rounded-b-lg shadow-lg p-4 md:p-6"></div>
        </div>

        <div class="mt-8 bg-gray-800 p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">5-Week Progress Tracker</h2>
            <div id="progressTrackerContainer" class="space-y-6"></div>
        </div>
    </div>

    <div id="confirmModal" class="modal-backdrop hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Advance to Next Week?</h3>
            <p class="text-gray-300 mb-6">This will archive the current week, make your "Next Week Preview" the new current week, and remove the oldest week's data. This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelNewWeek" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                <button id="confirmNewWeek" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Confirm & Advance</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const MAX_WEEKS_STORED = 6;
    const CURRENT_WEEK_INDEX = 4;
    const DATA_KEY = 'pilotPlannerDataV8';
    const VIEW_STATE_KEY = 'pilotPlannerViewStateV8';

    const appState = {
        weeks: [],
        indicators: [ { id: 1, name: 'Hours Studied' }, { id: 2, name: 'Maneuvers Practiced' } ],
        viewingIndex: CURRENT_WEEK_INDEX, currentView: 'weekly', currentDayIndex: 0,
    };

    // --- DOM Elements ---
    const app = document.getElementById('app');
    const weeklyGoalsEl = document.getElementById('weeklyGoals');
    const indicatorListEl = document.getElementById('indicatorList');
    const newIndicatorInput = document.getElementById('newIndicatorInput');
    const addIndicatorBtn = document.getElementById('addIndicatorBtn');
    const plannerContainer = document.getElementById('plannerContainer');
    const weeklyViewContainer = document.getElementById('weeklyViewContainer');
    const dailyViewContainer = document.getElementById('dailyViewContainer');
    const progressTrackerContainer = document.getElementById('progressTrackerContainer');
    const viewBtns = document.querySelectorAll('.view-btn');
    const startNewWeekBtn = document.getElementById('startNewWeekBtn');
    const confirmModal = document.getElementById('confirmModal');
    const cancelNewWeekBtn = document.getElementById('cancelNewWeek');
    const confirmNewWeekBtn = document.getElementById('confirmNewWeek');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const weekStatusEl = document.getElementById('weekStatus');
    const weekDateRangeEl = document.getElementById('weekDateRange');

    // --- UTILITIES ---
    const getStartOfWeek = (date = new Date()) => { const d = new Date(date); d.setDate(d.getDate() - d.getDay()); d.setHours(0,0,0,0); return d; };
    const getISOStringAtMidnight = (date) => { const d = new Date(date); d.setHours(0, 0, 0, 0); return d.toISOString(); };
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    // --- DATA & VIEW STATE MANAGEMENT ---
    const createNewWeek = (startDate) => ({
        startDate: getISOStringAtMidnight(startDate),
        weeklyGoals: 'Set new goals for the week...',
        schedule: {},
        kpiData: {},
        amendedItems: { weeklyGoals: false, schedule: {}, kpi: {} },
        originalState: null
    });

    const saveData = () => localStorage.setItem(DATA_KEY, JSON.stringify({ weeks: appState.weeks, indicators: appState.indicators }));
    const saveViewState = () => localStorage.setItem(VIEW_STATE_KEY, JSON.stringify({ viewingIndex: appState.viewingIndex, currentView: appState.currentView, currentDayIndex: appState.currentDayIndex }));

    const loadData = () => {
        const savedData = localStorage.getItem(DATA_KEY);
        if (!savedData) return;
        try {
            const parsedData = JSON.parse(savedData);
            appState.weeks = parsedData.weeks || [];
            appState.weeks.forEach(week => {
                if (!week.amendedItems) week.amendedItems = { weeklyGoals: false, schedule: {}, kpi: {} };
                if (week.originalState === undefined) week.originalState = null;
            });
            appState.indicators = parsedData.indicators || appState.indicators;
        } catch (error) { console.error("Failed to parse saved data:", error); }
    };

    const loadViewState = () => {
        const savedState = localStorage.getItem(VIEW_STATE_KEY);
        if (!savedState) return;
        try {
            const parsedState = JSON.parse(savedState);
            appState.viewingIndex = parsedState.viewingIndex ?? CURRENT_WEEK_INDEX;
            appState.currentView = parsedState.currentView ?? 'weekly';
            appState.currentDayIndex = parsedState.currentDayIndex ?? 0;
        } catch (error) { console.error("Failed to parse view state:", error); }
    };

    const initializeOrSyncState = () => {
        loadData();
        const today = new Date();
        const currentWeekStartDate = getStartOfWeek(today);
        if (appState.weeks.length === 0) {
            for (let i = -CURRENT_WEEK_INDEX; i < MAX_WEEKS_STORED - CURRENT_WEEK_INDEX; i++) {
                const weekStartDate = new Date(currentWeekStartDate);
                weekStartDate.setDate(weekStartDate.getDate() + (i * 7));
                appState.weeks.push(createNewWeek(weekStartDate));
            }
        } else {
            const storedCurrentWeekStart = new Date(appState.weeks[CURRENT_WEEK_INDEX].startDate);
            let weekDiff = Math.round((currentWeekStartDate.getTime() - storedCurrentWeekStart.getTime()) / (1000 * 60 * 60 * 24 * 7));
            if (weekDiff > 0) {
                for (let i = 0; i < weekDiff; i++) {
                    const weekToSnapshot = appState.weeks[CURRENT_WEEK_INDEX];
                    if (!weekToSnapshot.originalState) {
                        weekToSnapshot.originalState = {
                            weeklyGoals: weekToSnapshot.weeklyGoals,
                            schedule: deepClone(weekToSnapshot.schedule),
                            kpiData: deepClone(weekToSnapshot.kpiData)
                        };
                    }
                    const lastWeek = appState.weeks[appState.weeks.length - 1];
                    const nextWeekStartDate = new Date(lastWeek.startDate); nextWeekStartDate.setDate(nextWeekStartDate.getDate() + 7);
                    appState.weeks.push(createNewWeek(nextWeekStartDate)); appState.weeks.shift();
                }
            }
        }
        while(appState.weeks.length > MAX_WEEKS_STORED) appState.weeks.shift();
        loadViewState();
        if(appState.viewingIndex < 0 || appState.viewingIndex >= MAX_WEEKS_STORED) {
            appState.viewingIndex = CURRENT_WEEK_INDEX;
        }
        saveData();
    };
    
    // --- RENDERING ---
    const render = () => {
        if (!appState.weeks[appState.viewingIndex]) return;
        renderNavigation(); renderGoals(); renderIndicators(); updateViewButtons();
        if (appState.currentView === 'weekly') {
            weeklyViewContainer.classList.remove('hidden'); dailyViewContainer.classList.add('hidden'); renderWeeklyView();
        } else {
            weeklyViewContainer.classList.add('hidden'); dailyViewContainer.classList.remove('hidden'); renderDailyView();
        }
        renderProgressTracker();
    };
    
    const isWeekAmended = (week) => week.amendedItems.weeklyGoals || Object.values(week.amendedItems.schedule).some(v => v) || Object.values(week.amendedItems.kpi).some(v => v.goal || v.actual);

    const renderNavigation = () => {
        const week = appState.weeks[appState.viewingIndex];
        const startDate = new Date(week.startDate); const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6);
        let statusText = 'Past Week';
        if (appState.viewingIndex === CURRENT_WEEK_INDEX) statusText = 'Current Week';
        else if (appState.viewingIndex > CURRENT_WEEK_INDEX) statusText = 'Next Week (Preview)';
        else if (isWeekAmended(week)) statusText = 'Past Week <i class="amended-item text-sm">* (Amended)*</i>';
        weekStatusEl.innerHTML = statusText;
        weekDateRangeEl.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
        prevWeekBtn.disabled = appState.viewingIndex === 0;
        nextWeekBtn.disabled = appState.viewingIndex === appState.weeks.length - 1;
        startNewWeekBtn.style.display = appState.viewingIndex === CURRENT_WEEK_INDEX ? 'block' : 'none';
    };
    
    const renderGoals = () => {
        const week = appState.weeks[appState.viewingIndex];
        weeklyGoalsEl.innerHTML = week.weeklyGoals;
        weeklyGoalsEl.classList.toggle('amended-item', !!week.amendedItems.weeklyGoals);
    };

    const renderIndicators = () => {
        indicatorListEl.innerHTML = '';
        appState.indicators.forEach(ind => {
            indicatorListEl.insertAdjacentHTML('beforeend', `<div class="flex items-center justify-between bg-gray-900 p-2 rounded-md"><span class="text-gray-300">${ind.name}</span><button data-id="${ind.id}" class="remove-indicator-btn text-red-500 hover:text-red-400 font-bold">&times;</button></div>`);
        });
    };
    
    const renderWeeklyView = () => {
        const week = appState.weeks[appState.viewingIndex]; const weekStartDate = new Date(week.startDate);
        plannerContainer.innerHTML = '';
        plannerContainer.insertAdjacentHTML('beforeend', `<div class="table-cell font-semibold bg-gray-800 sticky top-0 z-10">Time</div>`);
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(weekStartDate); dayDate.setDate(weekStartDate.getDate() + i);
            plannerContainer.insertAdjacentHTML('beforeend', `<div class="table-cell font-semibold bg-gray-800 sticky top-0 z-10">${dayDate.toLocaleDateString(undefined, { weekday: 'short' })}<br>${dayDate.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' })}</div>`);
        }
        for (let hour = 6; hour <= 22; hour++) {
            plannerContainer.insertAdjacentHTML('beforeend', `<div class="table-cell font-semibold bg-gray-800">${hour}:00</div>`);
            for (let day = 0; day < 7; day++) {
                const key = `${day}-${hour}`; const isAmended = !!week.amendedItems.schedule[key];
                const content = week.schedule[key] || '';
                plannerContainer.insertAdjacentHTML('beforeend', `<div class="table-cell ${isAmended ? 'amended-item' : ''}" contenteditable="true" data-key="${key}">${content}${isAmended ? '<span class="amended-asterisk">*</span>' : ''}</div>`);
            }
        }
        appState.indicators.forEach(ind => {
            plannerContainer.insertAdjacentHTML('beforeend', `<div class="table-cell font-semibold bg-gray-800">${ind.name}</div>`);
            for (let day = 0; day < 7; day++) {
                const key = `${day}-${ind.id}`; const data = week.kpiData[key] || { goal: '', actual: '' };
                const goalAmended = week.amendedItems.kpi[key]?.goal; const actualAmended = week.amendedItems.kpi[key]?.actual;
                plannerContainer.insertAdjacentHTML('beforeend', `<div class="table-cell"><div class="flex flex-col sm:flex-row gap-1 justify-center items-center h-full">
                    <div class="relative w-full sm:w-1/2"><input type="number" min="0" data-key="${key}" data-type="goal" value="${data.goal}" placeholder="G" class="w-full bg-gray-700 text-white text-center rounded border-transparent focus:ring-1 focus:ring-blue-500 p-1">${goalAmended ? '<span class="amended-asterisk absolute -top-1 right-0">*</span>' : ''}</div>
                    <div class="relative w-full sm:w-1/2"><input type="number" min="0" data-key="${key}" data-type="actual" value="${data.actual}" placeholder="A" class="w-full bg-gray-600 text-white text-center rounded border-transparent focus:ring-1 focus:ring-blue-500 p-1">${actualAmended ? '<span class="amended-asterisk absolute -top-1 right-0">*</span>' : ''}</div>
                </div></div>`);
            }
        });
    };


  
  
    const renderDailyView = () => {
        const week = appState.weeks[appState.viewingIndex]; const weekStartDate = new Date(week.startDate);
        const dayDate = new Date(weekStartDate); dayDate.setDate(weekStartDate.getDate() + appState.currentDayIndex);
        dailyViewContainer.innerHTML = '';
        dailyViewContainer.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-center mb-6"><button id="prevDayBtn" class="nav-btn bg-gray-700 hover:bg-blue-600 p-2 rounded-md">&lt; Prev</button><h2 class="text-xl md:text-2xl font-bold text-center">${dayDate.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}</h2><button id="nextDayBtn" class="nav-btn bg-gray-700 hover:bg-blue-600 p-2 rounded-md">Next &gt;</button></div>`);
        let scheduleHTML = `<h3 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Schedule</h3><div class="space-y-2">`;
        for (let hour = 6; hour <= 22; hour++) {
            const key = `${appState.currentDayIndex}-${hour}`; const isAmended = !!week.amendedItems.schedule[key];
            const content = week.schedule[key] || '';
            scheduleHTML += `<div class="flex items-start gap-3"><span class="font-semibold text-gray-400 w-16 text-right pt-1">${hour}:00</span><div class="flex-1 bg-gray-800 rounded p-2 min-h-[40px] ${isAmended ? 'amended-item' : ''}" contenteditable="true" data-key="${key}">${content}${isAmended ? '<span class="amended-asterisk">*</span>' : ''}</div></div>`;
        }
        scheduleHTML += `</div>`;
        let kpiHTML = `<h3 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Key Performance Indicators</h3><div class="space-y-4">`;
        appState.indicators.forEach(ind => {
            const key = `${appState.currentDayIndex}-${ind.id}`; const data = week.kpiData[key] || { goal: '', actual: '' };
            const goalAmended = week.amendedItems.kpi[key]?.goal; const actualAmended = week.amendedItems.kpi[key]?.actual;
            kpiHTML += `<div class="bg-gray-800 p-3 rounded"><label class="block font-medium mb-2">${ind.name}</label><div class="flex gap-4">
                <div class="flex-1"><label class="text-sm text-gray-400">Goal ${goalAmended ? '<span class="amended-item">*</span>' : ''}</label><input type="number" min="0" data-key="${key}" data-type="goal" value="${data.goal}" class="w-full bg-gray-700 text-white text-center rounded border-transparent focus:ring-1 focus:ring-blue-500 p-2 mt-1"></div>
                <div class="flex-1"><label class="text-sm text-gray-400">Actual ${actualAmended ? '<span class="amended-item">*</span>' : ''}</label><input type="number" min="0" data-key="${key}" data-type="actual" value="${data.actual}" class="w-full bg-gray-600 text-white text-center rounded border-transparent focus:ring-1 focus:ring-blue-500 p-2 mt-1"></div>
            </div></div>`;
        });
        kpiHTML += `</div>`;
        dailyViewContainer.insertAdjacentHTML('beforeend', `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div>${scheduleHTML}</div><div>${kpiHTML}</div></div>`);
    };
    
    // --- FIX: Restored Progress Tracker Rendering ---
    const renderProgressTracker = () => {
        progressTrackerContainer.innerHTML = '';
        const weeksForChart = appState.weeks.slice(0, CURRENT_WEEK_INDEX + 1);
        appState.indicators.forEach(ind => {
            const chartDiv = document.createElement('div'); chartDiv.className = 'mb-4';
            const kpiIsAmendedInHistory = weeksForChart.some(w => Object.keys(w.amendedItems.kpi).some(key => key.endsWith(`-${ind.id}`) && w.amendedItems.kpi[key].actual));
            chartDiv.innerHTML = `<h3 class="text-md font-semibold text-white mb-3">${ind.name} ${kpiIsAmendedInHistory ? '<span class="amended-item text-sm">*</span>' : ''}</h3>`;
            const chartContainer = document.createElement('div'); chartContainer.className = 'flex items-end justify-around h-32 bg-gray-900 p-2 rounded-md space-x-2';
            const weekData = weeksForChart.map(w => calculateKpiTotalForWeek(w, ind.id));
            const maxVal = Math.max(...weekData, 1);
            weeksForChart.forEach((week, index) => chartContainer.appendChild(createBar((weekData[index] / maxVal) * 100, weekData[index], new Date(week.startDate), index === CURRENT_WEEK_INDEX)));
            chartDiv.appendChild(chartContainer); progressTrackerContainer.appendChild(chartDiv);
        });
    };

    const createBar = (height, value, date, isCurrent) => {
        const wrapper = document.createElement('div'); wrapper.className = 'flex-1 flex flex-col items-center text-center w-0';
        wrapper.innerHTML = `<div class="text-xs font-bold text-gray-300">${value}</div><div class="w-full rounded-t-md transition-all duration-300 ${isCurrent ? 'bg-blue-500' : 'bg-green-600'}" style="height: ${height}%"></div><div class="text-xs text-gray-400 mt-1">${isCurrent ? "Current" : date.toLocaleDateString(undefined, {month:'numeric', day:'numeric'})}</div>`;
        return wrapper;
    };
    const updateViewButtons = () => viewBtns.forEach(btn => { btn.classList.toggle('bg-blue-600', btn.dataset.view === appState.currentView); btn.classList.toggle('bg-gray-700', btn.dataset.view !== appState.currentView); });

    // --- AMENDMENT LOGIC ---
    const checkAmendment = (week, type, key, subkey, newValue) => {
        if (appState.viewingIndex >= CURRENT_WEEK_INDEX || !week.originalState) return false;
        let originalValue;
        switch(type) {
            case 'weeklyGoals': originalValue = week.originalState.weeklyGoals; break;
            case 'schedule': originalValue = week.originalState.schedule[key] || ''; break;
            case 'kpi': originalValue = week.originalState.kpiData[key]?.[subkey] || 0; break;
        }
        const isDifferent = originalValue != newValue; // Use != for type coercion (e.g., "5" vs 5)
        let changed = false;
        if (type === 'kpi') {
            if (!week.amendedItems.kpi[key]) week.amendedItems.kpi[key] = { goal: false, actual: false };
            if (week.amendedItems.kpi[key][subkey] !== isDifferent) {
                week.amendedItems.kpi[key][subkey] = isDifferent;
                changed = true;
            }
        } else {
             if (week.amendedItems[type][key] !== isDifferent) {
                week.amendedItems[type][key] = isDifferent;
                changed = true;
            }
        }
        return changed;
    };
    
    // --- EVENT HANDLERS ---
    const setupEventListeners = () => {
        prevWeekBtn.addEventListener('click', () => { if (appState.viewingIndex > 0) { appState.viewingIndex--; saveViewState(); render(); } });
        nextWeekBtn.addEventListener('click', () => { if (appState.viewingIndex < appState.weeks.length - 1) { appState.viewingIndex++; saveViewState(); render(); } });
        viewBtns.forEach(btn => btn.addEventListener('click', () => { appState.currentView = btn.dataset.view; saveViewState(); render(); }));
        addIndicatorBtn.addEventListener('click', () => { const name = newIndicatorInput.value.trim(); if (name) { const newId = appState.indicators.length > 0 ? Math.max(...appState.indicators.map(i => i.id)) + 1 : 1; appState.indicators.push({ id: newId, name: name }); newIndicatorInput.value = ''; saveData(); render(); }});
        indicatorListEl.addEventListener('click', e => { if(e.target.matches('.remove-indicator-btn')) { appState.indicators = appState.indicators.filter(i => i.id !== parseInt(e.target.dataset.id)); saveData(); render(); } });
        
        app.addEventListener('blur', e => {
            if (e.target.matches('[contenteditable][data-key]')) {
                const week = appState.weeks[appState.viewingIndex]; const key = e.target.dataset.key;
                const newContent = e.target.innerHTML.replace(/<span.*?<\/span>/g, '').trim();
                if (checkAmendment(week, 'schedule', key, null, newContent)) render();
                week.schedule[key] = newContent; 
                saveData();
            }
        }, true);

        app.addEventListener('input', e => {
             if (e.target.matches('input[type="number"][data-key]')) {
                const { key, type } = e.target.dataset; const week = appState.weeks[appState.viewingIndex];
                if (!week.kpiData[key]) week.kpiData[key] = { goal: 0, actual: 0 };
                const newValue = parseFloat(e.target.value) || 0;
                if (checkAmendment(week, 'kpi', key, type, newValue)) render();
                week.kpiData[key][type] = newValue; 
                saveData(); 
                renderProgressTracker();
            }
        });

        weeklyGoalsEl.addEventListener('blur', () => {
            const week = appState.weeks[appState.viewingIndex]; const newGoals = weeklyGoalsEl.innerHTML;
            if (checkAmendment(week, 'weeklyGoals', 'weeklyGoals', null, newGoals)) render();
            week.weeklyGoals = newGoals; 
            saveData();
        });
        
        // --- FIX: Daily View day change listener ---
        dailyViewContainer.addEventListener('click', e => { 
            let dayChanged = false;
            if (e.target.id === 'prevDayBtn') { appState.currentDayIndex = (appState.currentDayIndex - 1 + 7) % 7; dayChanged = true; }
            if (e.target.id === 'nextDayBtn') { appState.currentDayIndex = (appState.currentDayIndex + 1) % 7; dayChanged = true; }
            if(dayChanged) { saveViewState(); renderDailyView(); }
        });
        
        startNewWeekBtn.addEventListener('click', () => confirmModal.classList.remove('hidden'));
        cancelNewWeekBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
        confirmNewWeekBtn.addEventListener('click', () => {
            const weekToSnapshot = appState.weeks[CURRENT_WEEK_INDEX];
            if (!weekToSnapshot.originalState) {
                weekToSnapshot.originalState = {
                    weeklyGoals: weekToSnapshot.weeklyGoals,
                    schedule: deepClone(weekToSnapshot.schedule),
                    kpiData: deepClone(weekToSnapshot.kpiData)
                };
            }
            const lastWeek = appState.weeks[appState.weeks.length - 1];
            const nextWeekStartDate = new Date(lastWeek.startDate); nextWeekStartDate.setDate(nextWeekStartDate.getDate() + 7);
            appState.weeks.push(createNewWeek(nextWeekStartDate)); appState.weeks.shift();
            appState.viewingIndex = CURRENT_WEEK_INDEX; 
            saveData(); 
            saveViewState(); 
            render(); 
            confirmModal.classList.add('hidden');
        });
    };

    const calculateKpiTotalForWeek = (week, indicatorId, type = 'actual') => Object.keys(week.kpiData).filter(key => parseInt(key.split('-')[1]) === indicatorId).reduce((sum, key) => sum + (week.kpiData[key][type] || 0), 0);
    
    // --- KICKOFF ---
    initializeOrSyncState();
    setupEventListeners();
    render();
});
</script>
</body>
</html>


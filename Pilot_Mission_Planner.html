<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot's Mission Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light Gray */
            color: #111827; /* Dark Gray */
        }
        body.dark {
            background-color: #111827; /* Dark Gray */
            color: #F3F4F6; /* Light Gray */
        }
        .planner-grid {
            display: grid;
            grid-template-columns: 4rem repeat(7, 1fr);
            grid-template-rows: auto;
        }
        .time-cell {
            grid-column: 1;
            text-align: right;
            padding-right: 0.5rem;
            font-size: 12px;
        }
        .day-header {
            text-align: center;
            font-weight: 600;
            padding: 0.5rem 0;
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #f3f4f6;
        }
        body.dark .day-header {
            background-color: #111827;
        }
        .day-column {
            position: relative;
            border-left: 1px solid #e5e7eb;
        }
        body.dark .day-column {
            border-color: #374151;
        }
        .hour-separator {
            border-top: 1px solid #e5e7eb;
        }
        body.dark .hour-separator {
            border-color: #374151;
        }
        .planner-task {
            position: absolute;
            left: 2px;
            right: 2px;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            z-index: 10;
        }
        .overflow-indicator {
            position: absolute;
            bottom: 2px;
            left: 0;
            right: 0;
            font-size: 12px;
            font-weight: bold;
            color: #4f46e5;
            cursor: pointer;
            text-align: center;
        }
        body.dark .overflow-indicator {
            color: #a5b4fc;
        }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold">Pilot's Mission Planner</h1>
            <p class="mt-1">Plan your week, track your progress, ace that checkride.</p>
        </header>

        <div id="mainPlannerSection">
            <div class="flex justify-between items-center mb-4">
                <button id="prevWeekBtn" class="nav-btn bg-gray-700 hover:bg-blue-600 p-2 rounded-md text-white transition-colors">&lt; Prev Week</button>
                <div class="text-center">
                    <h2 id="weekStatus" class="text-xl md:text-2xl font-bold"></h2>
                    <p id="weekDateRange" class="text-sm"></p>
                </div>
                <button id="nextWeekBtn" class="nav-btn bg-gray-700 hover:bg-blue-600 p-2 rounded-md text-white transition-colors">Next Week &gt;</button>
            </div>

            <div id="weeklyViewContainer" class="overflow-x-auto bg-white dark:bg-gray-900 rounded-lg shadow-lg">
                <div id="plannerContainer" class="planner-grid"></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const savedTheming = JSON.parse(localStorage.getItem('theming')) || {};
    if (savedTheming.mode === 'dark') {
        document.body.classList.add('dark');
    }

    let mainTasks = [];
    let mainCategories = [];
    let appState = { viewingIndex: 0 };
    const START_HOUR = 6;
    const END_HOUR = 22;
    const HOUR_HEIGHT_PX = 60;
    const MAX_VISIBLE_TASKS = 2;

    const plannerContainer = document.getElementById('plannerContainer');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const weekStatusEl = document.getElementById('weekStatus');
    const weekDateRangeEl = document.getElementById('weekDateRange');

    const getStartOfWeek = (date = new Date()) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    };
    const getDurationMs = (amount, unit) => {
        if (!amount || !unit || amount <= 0) return 30 * 60000;
        return (unit === 'hours' ? amount * 3600000 : amount * 60000);
    };
    const getContrastingTextColor = (hex) => {
        if (!hex) return '#000';
        const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
        return ((r * 299 + g * 587 + b * 114) / 1000) > 128 ? '#000' : '#FFF';
    };

    const loadMainData = () => {
        try {
            const tasksData = localStorage.getItem('tasks');
            mainTasks = tasksData ? JSON.parse(tasksData).map(t => ({...t, dueDate: t.dueDate ? new Date(t.dueDate) : null})) : [];
            const categoriesData = localStorage.getItem('categories');
            mainCategories = categoriesData ? JSON.parse(categoriesData) : [];
        } catch (e) { console.error("Error loading data:", e); }
    };

    const render = () => {
        renderNavigation();
        renderWeeklyView();
    };

    const renderNavigation = () => {
        const today = new Date(2025, 8, 15);
        today.setDate(today.getDate() + (appState.viewingIndex * 7));
        const weekStartDate = getStartOfWeek(today);
        const weekEndDate = new Date(weekStartDate);
        weekEndDate.setDate(weekStartDate.getDate() + 6);
        weekStatusEl.textContent = appState.viewingIndex === 0 ? 'Current Week' : `Week of ${weekStartDate.toLocaleDateString()}`;
        weekDateRangeEl.textContent = `${weekStartDate.toLocaleDateString()} - ${weekEndDate.toLocaleDateString()}`;
    };

    const renderWeeklyView = () => {
        plannerContainer.innerHTML = '';

        const today = new Date(2025, 8, 15);
        today.setDate(today.getDate() + (appState.viewingIndex * 7));
        const weekStartDate = getStartOfWeek(today);

        // Render headers and grid structure
        let gridHtml = '<div class="day-header" style="grid-column: 1;">Time</div>';
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(weekStartDate);
            dayDate.setDate(weekStartDate.getDate() + i);
            gridHtml += `<div class="day-header" style="grid-column: ${i + 2};">${dayDate.toLocaleDateString(undefined, { weekday: 'short' })} ${dayDate.getDate()}</div>`;
        }
        plannerContainer.innerHTML = gridHtml;

        const gridBody = document.createElement('div');
        gridBody.style.gridColumn = '1 / -1';
        gridBody.style.display = 'grid';
        gridBody.style.gridTemplateColumns = '4rem repeat(7, 1fr)';
        gridBody.style.position = 'relative';

        const timeCol = document.createElement('div');
        const dayColsContainer = document.createElement('div');
        dayColsContainer.style.gridColumn = '2 / -1';
        dayColsContainer.style.display = 'grid';
        dayColsContainer.style.gridTemplateColumns = 'repeat(7, 1fr)';
        dayColsContainer.style.position = 'relative';

        for (let hour = START_HOUR; hour < END_HOUR; hour++) {
            timeCol.insertAdjacentHTML('beforeend', `<div class="time-cell hour-separator" style="height: ${HOUR_HEIGHT_PX}px;">${hour}:00</div>`);
        }

        for (let i = 0; i < 7; i++) {
             const dayCol = document.createElement('div');
             dayCol.className = 'day-column';
             dayCol.dataset.day = i;
             for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                 dayCol.insertAdjacentHTML('beforeend', `<div class="hour-separator" style="height: ${HOUR_HEIGHT_PX}px;"></div>`);
             }
             dayColsContainer.appendChild(dayCol);
        }

        gridBody.appendChild(timeCol);
        gridBody.appendChild(dayColsContainer);
        plannerContainer.appendChild(gridBody);

        const weekEndDate = new Date(weekStartDate);
        weekEndDate.setDate(weekStartDate.getDate() + 7);
        const tasksForWeek = mainTasks.filter(t => t.dueDate && t.dueDate >= weekStartDate && t.dueDate < weekEndDate);

        const slots = {};

        tasksForWeek.forEach(task => {
            const taskDate = new Date(task.dueDate);
            const day = taskDate.getDay();
            const hour = taskDate.getHours();
            const key = `${day}-${hour}`;
            if (!slots[key]) slots[key] = [];
            slots[key].push(task);
        });

        for (const key in slots) {
            const [day, hour] = key.split('-').map(Number);
            const tasksInSlot = slots[key];
            const dayColumn = dayColsContainer.querySelector(`.day-column[data-day="${day}"]`);

            if (tasksInSlot.length > MAX_VISIBLE_TASKS) {
                const indicator = document.createElement('div');
                indicator.className = 'overflow-indicator';
                indicator.textContent = `+${tasksInSlot.length - MAX_VISIBLE_TASKS} more`;
                indicator.style.top = `${(hour - START_HOUR) * HOUR_HEIGHT_PX + HOUR_HEIGHT_PX - 20}px`;
                dayColumn.appendChild(indicator);
            }

            tasksInSlot.slice(0, MAX_VISIBLE_TASKS).forEach(task => {
                const taskDate = new Date(task.dueDate);
                const startMinutes = (taskDate.getHours() * 60) + taskDate.getMinutes();
                const durationMinutes = getDurationMs(task.estimatedDurationAmount, task.estimatedDurationUnit) / 60000;

                const top = ((startMinutes - (START_HOUR * 60)) / 60) * HOUR_HEIGHT_PX;
                const height = (durationMinutes / 60) * HOUR_HEIGHT_PX;

                const taskEl = document.createElement('div');
                taskEl.className = 'planner-task';
                const category = mainCategories.find(c => c.id === task.categoryId);
                const bgColor = category ? category.color : '#6b7280';
                taskEl.style.backgroundColor = bgColor;
                taskEl.style.color = getContrastingTextColor(bgColor);
                taskEl.textContent = task.name;
                taskEl.style.top = `${top}px`;
                taskEl.style.height = `${height}px`;
                dayColumn.appendChild(taskEl);
            });
        }
    };

    const setupEventListeners = () => {
        prevWeekBtn.addEventListener('click', () => { appState.viewingIndex--; render(); });
        nextWeekBtn.addEventListener('click', () => { appState.viewingIndex++; render(); });
    };

    loadMainData();
    setupEventListeners();
    render();
});
</script>
</body>
</html>
